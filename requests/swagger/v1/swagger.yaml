openapi: 3.0.1
info:
  title: Chat API V1
  version: v1
  description: |
    Chat application API with support for applications, chats, and messages.
    
    **Authentication:** JWT token (stored in HTTP-only cookies) required for most endpoints.
    
    **Architecture:**
    - Async operations via RabbitMQ for chat/message creation
    - Redis-based atomic counters for chat and message numbering
    - Elasticsearch for full-text message search
    - Optimized queries: zero User table reads per request
    - Atomic UPDATE operations prevent race conditions
    
    **Performance:**
    - Average response time: <10ms
    - Pagination support on all list endpoints (max 100 items)
    - Input validation on all endpoints
paths:
  /api/v1/auth/register:
    post:
      summary: Register a new user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
                - password_confirmation
              properties:
                name:
                  type: string
                  example: "John Doe"
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                  description: Must be a valid email format
                password:
                  type: string
                  format: password
                  minLength: 6
                  maxLength: 128
                  example: "password123"
                password_confirmation:
                  type: string
                  format: password
                  example: "password123"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User created successfully"
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      email:
                        type: string
                        example: "john@example.com"
                      name:
                        type: string
                        example: "John Doe"
                      created_at:
                        type: string
                        format: date-time
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: string
                    example: ["Email has already been taken", "Password is too short"]
  
  /api/v1/auth/login:
    post:
      summary: Login user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
      responses:
        '200':
          description: Login successful (JWT stored in HTTP-only cookie)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged in successfully"
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      name:
                        type: string
                      created_at:
                        type: string
                        format: date-time
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid email or password"
  
  /api/v1/auth/logout:
    delete:
      summary: Logout user
      tags:
        - Authentication
      description: Clears the JWT authentication cookie
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out successfully"
  
  /api/v1/auth/me:
    get:
      summary: Get current user
      tags:
        - Authentication
      description: Returns the currently authenticated user's details
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      name:
                        type: string
                        example: "John Doe"
                      email:
                        type: string
                        example: "john@example.com"
                      created_at:
                        type: string
                        format: date-time
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unauthorized"
  
  
  /api/v1/applications:
    post:
      summary: Create a new application
      tags:
        - Applications
      description: |
        Creates a new application and returns a unique token.
        The token is used to identify the application in subsequent API calls.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 1
                  example: "My Chat App"
      responses:
        '201':
          description: Application created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    format: uuid
                    example: "550e8400-e29b-41d4-a716-446655440000"
        '401':
          description: Unauthorized
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: string
                    example: ["Name can't be blank"]
    
    put:
      summary: Update an application
      tags:
        - Applications
      description: |
        Updates the name of an existing application.
        Uses atomic UPDATE operation for thread safety.
        Only the application creator can update it.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - name
              properties:
                token:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440000"
                name:
                  type: string
                  example: "Updated App Name"
      responses:
        '200':
          description: Application updated successfully
        '403':
          description: Forbidden - not the application creator
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Application not found or you do not have permission to edit it"
        '422':
          description: Validation error
    
    get:
      summary: List all applications
      tags:
        - Applications
      description: Lists all applications with pagination support
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (starts at 1)
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Items per page (max 100)
      responses:
        '200':
          description: List of applications
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    token:
                      type: string
                      format: uuid
                    name:
                      type: string
                    chatsCount:
                      type: integer
                      description: Number of chats in this application
                example:
                  - token: "550e8400-e29b-41d4-a716-446655440000"
                    name: "My Chat App"
                    chatsCount: 5
        '401':
          description: Unauthorized
        '422':
          description: Invalid pagination parameters
  
  /api/v1/applications/{token}/chats:
    post:
      summary: Create a new chat
      tags:
        - Chats
      description: |
        Creates a new chat asynchronously via RabbitMQ.
        Returns the chat number immediately. The actual database write happens in the background.
        Uses Redis atomic counter for chat numbering to prevent race conditions.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Application token
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '201':
          description: Chat creation initiated (async processing)
          content:
            application/json:
              schema:
                type: object
                properties:
                  chatNumber:
                    type: integer
                    example: 1
                    description: Unique chat number within the application
        '404':
          description: Application not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Application not found"
    
    get:
      summary: List all chats for an application
      tags:
        - Chats
      description: Lists all chats with pagination support
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Items per page (max 100)
      responses:
        '200':
          description: List of chats
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    chatNumber:
                      type: integer
                    messagesCount:
                      type: integer
                      description: Number of messages in this chat
                example:
                  - chatNumber: 1
                    messagesCount: 42
                  - chatNumber: 2
                    messagesCount: 15
        '404':
          description: Application not found
        '422':
          description: Invalid pagination parameters
  
  /api/v1/applications/{token}/chats/{chatNumber}/messages:
    post:
      summary: Create a new message
      tags:
        - Messages
      description: |
        Creates a new message asynchronously via RabbitMQ.
        Returns the message number immediately. Actual database write and Elasticsearch indexing happen in the background.
        Uses Redis atomic counter for message numbering.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: chatNumber
          in: path
          required: true
          schema:
            type: integer
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - body
              properties:
                body:
                  type: string
                  minLength: 1
                  example: "Hello, world!"
                  description: Message content
      responses:
        '200':
          description: Message creation initiated (async processing)
          content:
            application/json:
              schema:
                type: object
                properties:
                  messageNumber:
                    type: integer
                    example: 1
                    description: Unique message number within the chat
        '404':
          description: Chat not found
        '422':
          description: Validation error
    
    put:
      summary: Update a message
      tags:
        - Messages
      description: |
        Updates an existing message using atomic UPDATE operation.
        Only the message creator can update it.
        Update is indexed to Elasticsearch asynchronously.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: chatNumber
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message_number
                - body
              properties:
                message_number:
                  type: integer
                  example: 1
                body:
                  type: string
                  example: "Updated message content"
      responses:
        '200':
          description: Message updated successfully
        '403':
          description: Forbidden - can only edit your own messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "You can only edit your own messages"
        '404':
          description: Message not found
        '422':
          description: Validation error
    
    get:
      summary: List messages in a chat
      tags:
        - Messages
      description: Lists all messages with pagination
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: chatNumber
          in: path
          required: true
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    messageNumber:
                      type: integer
                    senderName:
                      type: string
                    body:
                      type: string
                    createdAt:
                      type: string
                      format: date-time
                example:
                  - messageNumber: 1
                    senderName: "John Doe"
                    body: "Hello, world!"
                    createdAt: "2025-11-09T10:30:00Z"
        '404':
          description: Chat not found
        '422':
          description: Invalid pagination parameters
  
  /api/v1/applications/{token}/chats/{chatNumber}/messages/search:
    get:
      summary: Search messages in a chat
      tags:
        - Messages
      description: |
        Full-text search messages using Elasticsearch.
        Searches the message body content.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: chatNumber
          in: path
          required: true
          schema:
            type: integer
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: Search query string
          example: "hello world"
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    messageNumber:
                      type: integer
                    body:
                      type: string
                    createdAt:
                      type: string
                      format: date-time
                example:
                  - messageNumber: 5
                    body: "Hello world from Elasticsearch"
                    createdAt: "2025-11-09T10:30:00Z"
        '404':
          description: Chat not found
        '422':
          description: Missing or invalid search query

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: JWT token stored in HTTP-only cookie
  
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
    
    ValidationErrors:
      type: object
      properties:
        errors:
          type: array
          items:
            type: string
    
    User:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        name:
          type: string
        created_at:
          type: string
          format: date-time
    
    Application:
      type: object
      properties:
        token:
          type: string
          format: uuid
        name:
          type: string
        chatsCount:
          type: integer
    
    Chat:
      type: object
      properties:
        chatNumber:
          type: integer
        messagesCount:
          type: integer
    
    Message:
      type: object
      properties:
        messageNumber:
          type: integer
        senderName:
          type: string
        body:
          type: string
        createdAt:
          type: string
          format: date-time

security:
  - cookieAuth: []
